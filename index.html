<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>AR Hand Controller 3D - Cubo Universal</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body {
            background: #1e1e1e;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            position: fixed;
            touch-action: none;
        }
        .container {
            position: relative;
            width: 100%;
            height: 100%;
            background: #000;
        }
        #input_video { display: none; }
        #webgl_canvas, #hand_canvas {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
        }
        #webgl_canvas { z-index: 2; }
        #hand_canvas { z-index: 3; }
        
        .ui {
            position: absolute;
            padding: 8px 12px;
            background: rgba(0,0,0,0.85);
            border-radius: 6px;
            z-index: 10;
            font-size: 11px;
            line-height: 1.4;
        }
        #info { top: 10px; left: 10px; max-width: 200px; }
        #info h3 { color: #4CAF50; font-size: 13px; margin: 0 0 5px 0; }
        .gi { margin: 3px 0; padding-left: 5px; }
        #status { top: 10px; right: 10px; }
        .hs { display: flex; align-items: center; gap: 5px; margin: 2px 0; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #555; flex-shrink: 0; }
        .dot.active { background: #4CAF50; box-shadow: 0 0 8px #4CAF50; }
        #inst { bottom: 10px; left: 50%; transform: translateX(-50%); text-align: center; max-width: 90%; }
        
        #loadingMsg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            background: rgba(0,0,0,0.95);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            max-width: 80%;
        }
        #startBtn {
            padding: 12px 25px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
        }
        #startBtn:hover { background: #45a049; }
        
        /* Tablet */
        @media (min-width: 768px) {
            .ui { font-size: 12px; padding: 10px 15px; }
            #info { max-width: 250px; }
            #info h3 { font-size: 15px; margin-bottom: 8px; }
            .gi { font-size: 12px; margin: 4px 0; }
            #inst { font-size: 13px; padding: 12px 20px; }
            .dot { width: 9px; height: 9px; }
        }
        
        /* Desktop */
        @media (min-width: 1024px) {
            body { display: flex; align-items: center; justify-content: center; }
            .container { 
                max-width: 1280px; 
                max-height: 720px; 
                border-radius: 12px; 
                box-shadow: 0 0 20px rgba(0,0,0,0.5); 
            }
            .ui { font-size: 13px; }
            #info { top: 20px; left: 20px; padding: 15px; max-width: 300px; }
            #info h3 { font-size: 16px; margin-bottom: 10px; }
            .gi { font-size: 13px; margin: 5px 0; padding-left: 10px; }
            #status { top: 20px; right: 20px; padding: 10px 15px; font-size: 12px; }
            #inst { bottom: 20px; font-size: 14px; padding: 15px 25px; }
            .dot { width: 10px; height: 10px; }
        }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
    <div class="container">
        <div id="loadingMsg">
            <div>Cargando cubo 3D y IA...</div>
            <button id="startBtn" style="display:none;">Iniciar C√°mara</button>
        </div>
        
        <div id="info" class="ui">
            <h3>üéÆ Controles</h3>
            <div class="gi">ü§è <strong>Derecha</strong>: Rotar objeto</div>
            <div class="gi">ü§è <strong>Izquierda</strong>: Trasladar</div>
            <div class="gi">ü§èü§è <strong>Ambas</strong>: Escalar (zoom)</div>
            <div class="gi">‚úãü§è <strong>D. abierta + I. pinza</strong>: Mover cara</div>
        </div>

        <div id="status" class="ui">
            <div class="hs"><span class="dot" id="ld"></span><span id="lt">Izq: --</span></div>
            <div class="hs"><span class="dot" id="rd"></span><span id="rt">Der: --</span></div>
        </div>

        <video id="input_video" playsinline></video>
        <canvas id="webgl_canvas"></canvas>
        <canvas id="hand_canvas"></canvas>
        
        <div id="inst" class="ui">Esperando gestos...</div>
    </div>

    <script>
        const vid = document.getElementById('input_video');
        const load = document.getElementById('loadingMsg');
        const btn = document.getElementById('startBtn');
        const wgl = document.getElementById('webgl_canvas');
        const hnd = document.getElementById('hand_canvas');
        const ctx = hnd.getContext('2d');
        const inst = document.getElementById('inst');
        const ld = document.getElementById('ld');
        const rd = document.getElementById('rd');
        const lt = document.getElementById('lt');
        const rt = document.getElementById('rt');

        let started = false, renderer = null;
        
        function resize() {
            const w = window.innerWidth, h = window.innerHeight;
            wgl.width = w; wgl.height = h;
            hnd.width = w; hnd.height = h;
            if (renderer) {
                renderer.setSize(w, h);
                cam.aspect = w / h;
                cam.updateProjectionMatrix();
            }
        }
        window.addEventListener('resize', resize);
        window.addEventListener('orientationchange', () => setTimeout(resize, 100));

        let obj = null;
        const scene = new THREE.Scene();
        const INITIAL_SCALE = 3;
        const cam = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({ canvas: wgl, alpha: true, antialias: true });
        renderer.setClearColor(0x000000, 0);
        
        const light = new THREE.DirectionalLight(0xffffff, 2);
        light.position.set(5, 5, 5);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0x404040));
        cam.position.z = 5;
        resize();

        let ray = new THREE.Raycaster();
        let ms = new THREE.Vector2();
        let sel = null;
        let initPos = new THREE.Vector3();

        function buildCube() {
            if (obj) scene.remove(obj);
            
            load.style.display = 'block';
            load.innerHTML = 'Construyendo cubo 3D...';
            
            const cubeSize = 1;
            const halfSize = cubeSize / 2;
            const baseMat = new THREE.MeshPhongMaterial({ side: THREE.DoubleSide, transparent: true, opacity: 0.9 });
            
            const faceDefs = [
                { pos: [halfSize, 0, 0], rot: [0, Math.PI / 2, 0], color: 0xFF0000 },
                { pos: [-halfSize, 0, 0], rot: [0, -Math.PI / 2, 0], color: 0x00FF00 },
                { pos: [0, halfSize, 0], rot: [-Math.PI / 2, 0, 0], color: 0x0000FF },
                { pos: [0, -halfSize, 0], rot: [Math.PI / 2, 0, 0], color: 0xFFFF00 },
                { pos: [0, 0, halfSize], rot: [0, 0, 0], color: 0xFF00FF },
                { pos: [0, 0, -halfSize], rot: [0, Math.PI, 0], color: 0x00FFFF }
            ];

            const grp = new THREE.Group();
            const planeGeo = new THREE.PlaneGeometry(cubeSize, cubeSize);

            faceDefs.forEach(def => {
                const mat = baseMat.clone();
                mat.color.setHex(def.color);
                const mesh = new THREE.Mesh(planeGeo, mat);
                mesh.position.set(def.pos[0], def.pos[1], def.pos[2]);
                mesh.rotation.set(def.rot[0], def.rot[1], def.rot[2]);
                mesh.userData.f = true;
                mesh.add(new THREE.LineSegments(
                    new THREE.EdgesGeometry(mesh.geometry),
                    new THREE.LineBasicMaterial({ color: 0xffffff, linewidth: 2 })
                ));
                grp.add(mesh);
            });
            
            obj = grp;
            obj.scale.set(INITIAL_SCALE, INITIAL_SCALE, INITIAL_SCALE);
            obj.position.set(0, -0.5, 0);
            obj.rotation.y = Math.PI;
            scene.add(obj);
            
            load.style.display = 'none';
        }
        buildCube();

        const MP = 5;
        let rot=false, lrx=0, lry=0, lra=0, trx=0, try_=0, trz=0;
        let trans=false, scal=false, lsd=null, mvf=false, lfx=0, lfy=0;
        const RF=2.5, RZF=1.5, RS=0.15, PS=0.15, SS=15.0, FS=0.25;

        function dist(x1,y1,x2,y2) { return Math.sqrt((x2-x1)**2+(y2-y1)**2); }
        function ang(x1,y1,x2,y2) { return Math.atan2(y2-y1,x2-x1); }
        function n3d(x,y) { return {x:x*MP-MP/2, y:-(y*MP-MP/2)}; }
        function n2c(x,y) { return {x:(1-x)*wgl.width, y:y*wgl.height}; }
        function c2n(x,y) { return new THREE.Vector2(x/wgl.width*2-1, -(y/wgl.height*2-1)); }

        function rotR(it,tt) {
            if(!obj) return;
            const px=(it.x+tt.x)/2, py=(it.y+tt.y)/2;
            if(!rot) {
                rot=true; lrx=px; lry=py; lra=ang(it.x,it.y,tt.x,tt.y)*-1;
                trx=obj.rotation.x; try_=obj.rotation.y; trz=obj.rotation.z;
            } else {
                const dx=px-lrx, dy=py-lry, ca=ang(it.x,it.y,tt.x,tt.y)*-1;
                try_+=dx*RF; trx+=dy*RF;
                let ad=ca-lra;
                if(ad>Math.PI) ad-=2*Math.PI;
                else if(ad<-Math.PI) ad+=2*Math.PI;
                trz+=ad*RZF*0.3;
                lrx=px; lry=py; lra=ca;
            }
            obj.rotation.x+=(trx-obj.rotation.x)*RS;
            obj.rotation.y+=(try_-obj.rotation.y)*RS;
            obj.rotation.z+=(trz-obj.rotation.z)*RS;
        }

        function movL(it,tt) {
            if(!obj) return;
            const p3=n3d((it.x+tt.x)/2,(it.y+tt.y)/2);
            obj.position.x+=(p3.x-obj.position.x)*PS;
            obj.position.y+=(p3.y-obj.position.y)*PS;
        }

        function zoom(lp,rp) {
            if(!obj) return;
            const d=dist(lp.x,lp.y,rp.x,rp.y);
            if(lsd!==null) {
                const dd=d-lsd;
                let ns=Math.max(0.5,Math.min(15,obj.scale.x+dd*SS));
                const sm=0.3;
                obj.scale.x+=(ns-obj.scale.x)*sm;
                obj.scale.y+=(ns-obj.scale.y)*sm;
                obj.scale.z+=(ns-obj.scale.z)*sm;
            }
            lsd=d;
        }

        function movF(it,tt,ip) {
            if(!obj) return;
            const px=(it.x+tt.x)/2, py=(it.y+tt.y)/2, p3=n3d(px,py);
            if(ip&&!sel&&!mvf) {
                const pc=n2c(px,py);
                ms=c2n(pc.x,pc.y);
                ray.setFromCamera(ms,cam);
                const its=ray.intersectObjects(obj.children.filter(o=>o.userData.f),false);
                if(its.length>0) {
                    sel=its[0].object;
                    sel.material.emissive.setHex(0x555555);
                    initPos.copy(sel.position);
                    lfx=p3.x; lfy=p3.y; mvf=true;
                }
            } else if(ip&&sel&&mvf) {
                const dx=p3.x-lfx, dy=p3.y-lfy;
                const wm=new THREE.Vector3(dx,dy,0), lm=wm.clone();
                lm.applyQuaternion(obj.quaternion.clone().invert());
                sel.position.x+=lm.x*FS;
                sel.position.y+=lm.y*FS;
                sel.position.z+=lm.z*FS;
                lfx=p3.x; lfy=p3.y;
            } else if(!ip&&sel) {
                sel.material.emissive.setHex(0x000000);
                sel=null; mvf=false;
            }
        }

        function onRes(res) {
            if(load.style.display!=='none'&&obj) load.style.display='none';
            ctx.save();
            ctx.clearRect(0,0,hnd.width,hnd.height);
            const hds=[];
            if(res.multiHandLandmarks&&res.multiHandedness) {
                for(let i=0;i<res.multiHandLandmarks.length;i++) {
                    const lm=res.multiHandLandmarks[i], h=res.multiHandedness[i].label;
                    const it=lm[8], tt=lm[4];
                    const ip=dist(it.x,it.y,tt.x,tt.y)<0.10;
                    const io=dist(lm[5].x,lm[5].y,it.x,it.y)>0.12&&dist(lm[9].x,lm[9].y,lm[12].x,lm[12].y)>0.12&&
                            dist(lm[13].x,lm[13].y,lm[16].x,lm[16].y)>0.10&&dist(lm[17].x,lm[17].y,lm[20].x,lm[20].y)>0.10&&!ip;
                    hds.push({h,lm,it,tt,ip,io,px:(it.x+tt.x)/2,py:(it.y+tt.y)/2});
                    drawConnectors(ctx,lm,HAND_CONNECTIONS,{color:h==='Right'?'#00CC00':'#0099FF',lineWidth:2});
                    drawLandmarks(ctx,lm,{color:ip?'#FF0000':'#FFFF00',lineWidth:1});
                }
            }
            const lh=hds.find(h=>h.h==='Left'), rh=hds.find(h=>h.h==='Right');
            if(lh) { ld.classList.add('active'); lt.textContent=lh.ip?'Izq: ü§è':(lh.io?'Izq: ‚úã':'Izq: üëä'); }
            else { ld.classList.remove('active'); lt.textContent='Izq: --'; }
            if(rh) { rd.classList.add('active'); rt.textContent=rh.ip?'Der: ü§è':(rh.io?'Der: ‚úã':'Der: üëä'); }
            else { rd.classList.remove('active'); rt.textContent='Der: --'; }
            
            let act='Esperando gestos...';
            if(rh&&rh.io&&lh&&lh.ip) {
                movF(lh.it,lh.tt,true);
                act='‚úãü§è MODO MOVER CARA';
                rot=false; trans=false; lsd=null;
            } else if(lh&&rh&&lh.ip&&rh.ip) {
                zoom({x:lh.px,y:lh.py},{x:rh.px,y:rh.py});
                act='ü§èü§è ESCALANDO';
                rot=false; trans=false;
                if(sel){sel.material.emissive.setHex(0x000000);sel=null;mvf=false;}
            } else if(rh&&rh.ip&&(!lh||!lh.ip)) {
                rotR(rh.it,rh.tt);
                act='ü§è ROTANDO';
                trans=false; lsd=null;
                if(sel){sel.material.emissive.setHex(0x000000);sel=null;mvf=false;}
            } else if(lh&&lh.ip&&(!rh||!rh.ip)) {
                movL(lh.it,lh.tt);
                act='ü§è TRASLADANDO';
                rot=false; lsd=null;
                if(sel){sel.material.emissive.setHex(0x000000);sel=null;mvf=false;}
            } else {
                rot=false; trans=false; lsd=null;
                if(sel){sel.material.emissive.setHex(0x000000);sel=null;mvf=false;}
            }
            inst.innerHTML=act;
            if(obj) renderer.render(scene,cam);
            ctx.restore();
        }

        const hnds=new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
        hnds.setOptions({maxNumHands:2,modelComplexity:1,minDetectionConfidence:0.7,minTrackingConfidence:0.7});
        hnds.onResults(onRes);

        async function start() {
            try {
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                const strm=await navigator.mediaDevices.getUserMedia({
                    video:{
                        facingMode:'user',
                        width:{ideal: isMobile ? 640 : 1280},
                        height:{ideal: isMobile ? 480 : 720}
                    }
                });
                vid.srcObject=strm;
                await vid.play();
                const cf=new Camera(vid,{
                    onFrame:async()=>{await hnds.send({image:vid});},
                    width: isMobile ? 640 : 1280,
                    height: isMobile ? 480 : 720
                });
                cf.start();
                started=true;
                load.textContent='Iniciando IA...';
                setTimeout(()=>{if(obj)load.style.display='none';},1500);
            } catch(e) {
                console.error(e);
                load.innerHTML='‚ùå Error de c√°mara<br><small>Permite acceso en configuraci√≥n</small>';
                btn.textContent='Reintentar';
                btn.style.display='block';
            }
        }

        btn.onclick=()=>{
            btn.style.display='none';
            load.innerHTML='Accediendo a c√°mara...';
            start();
        };

        if(navigator.mediaDevices) {
            start().catch(()=> setTimeout(()=>{if(!started) btn.style.display='block';},500));
        } else {
            load.innerHTML='‚ùå Navegador no compatible';
        }
    </script>
</body>
</html>
